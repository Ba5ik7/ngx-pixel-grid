import { Inject, Injectable, InjectionToken, Optional } from '@angular/core';
import { PixelGrid } from './classes/pixel-grid';
import * as i0 from "@angular/core";
export const NGX_PIXEL_GRID_OPTIONS = new InjectionToken('NGX_PIXEL_GRID_OPTIONS');
const defaultOptions = {
    introAnimation: true,
    gutter: 1,
    rows: 100,
    columns: 100,
    tileSize: { width: 10, height: 10 },
    tileColor: 'rgb(140, 140, 140)',
    tileHoverColor: 'rgb(70, 70, 70)'
};
export class NgxPixelGridService {
    constructor(options) {
        this.options = defaultOptions;
        options && Object.assign(this.options, options);
    }
    createCtx(tilesMatrix, canvas) {
        const ctx = canvas.getContext('2d');
        const pixelGridSize = this.getPixelGridSize(tilesMatrix, this.options.gutter);
        canvas.width = pixelGridSize.width;
        canvas.height = pixelGridSize.height;
        canvas.style.cursor = 'pointer';
        return ctx;
    }
    buildTilesMatrix() {
        const { columns, rows, gutter, tileSize, tileColor, tileHoverColor } = this.options;
        const pixelGrid = new PixelGrid(columns, rows, gutter);
        const tilesMatrix = pixelGrid.buildTilesMatrix(tileSize, tileColor, tileHoverColor);
        return { pixelGrid, tilesMatrix };
    }
    getPixelGridSize(tilesMatrix, gutter) {
        const width = tilesMatrix[0].length * tilesMatrix[0][0].size.width + (tilesMatrix[0].length - 1) * gutter;
        const height = tilesMatrix.length * tilesMatrix[0][0].size.height + (tilesMatrix.length - 1) * gutter;
        return { width, height };
    }
    mergeTilesMatrix(tilesMatrix, tiles) {
        tiles.forEach((tile) => {
            const tileCoordinates = tile.coordinates;
            const { x, y } = tileCoordinates;
            // make a copy of tilesMatrix[x][y]
            const test = `${tilesMatrix[x][y].id}`;
            console.log({
                test,
                shouldBe: `${(x + 10) * (y + 10)}`,
                tile
            });
            const _tile = tilesMatrix[x][y];
            Object.assign(_tile, {
                isPixel: true,
                img: tile.img,
                color: 'rbg(0, 0, 0)',
                href: tile.href,
                tooltipText: tile.tooltipText
            });
        });
        return tilesMatrix;
    }
    whatTileIsMouseOver(tilesMatrix, rect, event) {
        const x = event.clientX - rect.left;
        const y = event.clientY - rect.top;
        let returnTile;
        tilesMatrix.forEach((row) => {
            row.forEach((tile) => {
                if (x >= tile.coordinates.x && x <= tile.coordinates.x + tile.size.width &&
                    y >= tile.coordinates.y && y <= tile.coordinates.y + tile.size.height) {
                    returnTile = tile;
                }
            });
        });
        return returnTile;
    }
    phyllotaxisLayout(tilesMatrix, xOffset = 0, yOffset = 0, iOffset = 0) {
        // theta determines the spiral of the layout
        const theta = Math.PI * (3 - Math.sqrt(5));
        const pointRadius = this.options.tileSize.width / 2;
        tilesMatrix.forEach((row, i) => {
            const index = (i + iOffset) % tilesMatrix.length;
            const phylloX = pointRadius * Math.sqrt(index) * Math.cos(index * theta);
            const phylloY = pointRadius * Math.sqrt(index) * Math.sin(index * theta);
            row.forEach(tile => {
                tile.coordinates.x = xOffset + phylloX - pointRadius;
                tile.coordinates.y = yOffset + phylloY - pointRadius;
            });
        });
        return tilesMatrix;
    }
}
NgxPixelGridService.ɵfac = function NgxPixelGridService_Factory(t) { return new (t || NgxPixelGridService)(i0.ɵɵinject(NGX_PIXEL_GRID_OPTIONS, 8)); };
NgxPixelGridService.ɵprov = /*@__PURE__*/ i0.ɵɵdefineInjectable({ token: NgxPixelGridService, factory: NgxPixelGridService.ɵfac, providedIn: 'root' });
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && i0.ɵsetClassMetadata(NgxPixelGridService, [{
        type: Injectable,
        args: [{
                providedIn: 'root'
            }]
    }], function () { return [{ type: undefined, decorators: [{
                type: Optional
            }, {
                type: Inject,
                args: [NGX_PIXEL_GRID_OPTIONS]
            }] }]; }, null); })();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmd4LXBpeGVsLWdyaWQuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3Byb2plY3RzL25neC1waXhlbC1ncmlkL3NyYy9saWIvbmd4LXBpeGVsLWdyaWQuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxjQUFjLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzdFLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQzs7QUFHakQsTUFBTSxDQUFDLE1BQU0sc0JBQXNCLEdBQUcsSUFBSSxjQUFjLENBQW9CLHdCQUF3QixDQUFDLENBQUM7QUFDdEcsTUFBTSxjQUFjLEdBQXNCO0lBQ3hDLGNBQWMsRUFBRSxJQUFJO0lBQ3BCLE1BQU0sRUFBRSxDQUFDO0lBQ1QsSUFBSSxFQUFFLEdBQUc7SUFDVCxPQUFPLEVBQUUsR0FBRztJQUNaLFFBQVEsRUFBRSxFQUFFLEtBQUssRUFBRSxFQUFFLEVBQUUsTUFBTSxFQUFFLEVBQUUsRUFBRTtJQUNuQyxTQUFTLEVBQUUsb0JBQW9CO0lBQy9CLGNBQWMsRUFBRSxpQkFBaUI7Q0FDbEMsQ0FBQztBQUtGLE1BQU0sT0FBTyxtQkFBbUI7SUFFOUIsWUFBd0QsT0FBMEI7UUFHbEYsWUFBTyxHQUFHLGNBQWMsQ0FBQztRQUZ2QixPQUFPLElBQUksTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQ2xELENBQUM7SUFHRCxTQUFTLENBQUMsV0FBc0IsRUFBRSxNQUF5QjtRQUN6RCxNQUFNLEdBQUcsR0FBRyxNQUFNLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBRSxDQUFDO1FBQ3JDLE1BQU0sYUFBYSxHQUNqQixJQUFJLENBQUMsZ0JBQWdCLENBQUMsV0FBVyxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7UUFD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QyxLQUFLLEdBQUcsS0FBSyxDQUFDLENBQUM7WUFDekUsTUFBTSxPQUFPLEdBQUcsV0FBVyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDLENBQUM7WUFDekUsR0FBRyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRTtnQkFDakIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDLEdBQUcsT0FBTyxHQUFHLE9BQU8sR0FBRyxXQUFXLENBQUM7Z0JBQ3JELElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQyxHQUFHLE9BQU8sR0FBRyxPQUFPLEdBQUcsV0FBVyxDQUFDO1lBQ3ZELENBQUMsQ0FBQyxDQUFDO1FBQ0wsQ0FBQyxDQUFDLENBQUM7UUFFSCxPQUFPLFdBQVcsQ0FBQztJQUNyQixDQUFDOztzRkExRlUsbUJBQW1CLGNBRUUsc0JBQXNCO3lFQUYzQyxtQkFBbUIsV0FBbkIsbUJBQW1CLG1CQUZsQixNQUFNO3VGQUVQLG1CQUFtQjtjQUgvQixVQUFVO2VBQUM7Z0JBQ1YsVUFBVSxFQUFFLE1BQU07YUFDbkI7O3NCQUdjLFFBQVE7O3NCQUFJLE1BQU07dUJBQUMsc0JBQXNCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0LCBJbmplY3RhYmxlLCBJbmplY3Rpb25Ub2tlbiwgT3B0aW9uYWwgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IFBpeGVsR3JpZCB9IGZyb20gJy4vY2xhc3Nlcy9waXhlbC1ncmlkJztcbmltcG9ydCB7IElQaXhlbEdyaWRPcHRpb25zLCBJUGl4ZWxHcmlkU2VydmljZSwgSVNpemUsIElUaWxlIH0gZnJvbSAnLi9pbnRlcmZhY2VzL25neC1waXhlbC1ncmlkJztcblxuZXhwb3J0IGNvbnN0IE5HWF9QSVhFTF9HUklEX09QVElPTlMgPSBuZXcgSW5qZWN0aW9uVG9rZW48SVBpeGVsR3JpZE9wdGlvbnM+KCdOR1hfUElYRUxfR1JJRF9PUFRJT05TJyk7XG5jb25zdCBkZWZhdWx0T3B0aW9uczogSVBpeGVsR3JpZE9wdGlvbnMgPSB7XG4gIGludHJvQW5pbWF0aW9uOiB0cnVlLFxuICBndXR0ZXI6IDEsXG4gIHJvd3M6IDEwMCxcbiAgY29sdW1uczogMTAwLFxuICB0aWxlU2l6ZTogeyB3aWR0aDogMTAsIGhlaWdodDogMTAgfSxcbiAgdGlsZUNvbG9yOiAncmdiKDE0MCwgMTQwLCAxNDApJyxcbiAgdGlsZUhvdmVyQ29sb3I6ICdyZ2IoNzAsIDcwLCA3MCknXG59O1xuXG5ASW5qZWN0YWJsZSh7XG4gIHByb3ZpZGVkSW46ICdyb290J1xufSlcbmV4cG9ydCBjbGFzcyBOZ3hQaXhlbEdyaWRTZXJ2aWNlIGltcGxlbWVudHMgSVBpeGVsR3JpZFNlcnZpY2Uge1xuXG4gIGNvbnN0cnVjdG9yKEBPcHRpb25hbCgpIEBJbmplY3QoTkdYX1BJWEVMX0dSSURfT1BUSU9OUykgb3B0aW9uczogSVBpeGVsR3JpZE9wdGlvbnMpIHsgXG4gICAgb3B0aW9ucyAmJiBPYmplY3QuYXNzaWduKHRoaXMub3B0aW9ucywgb3B0aW9ucyk7XG4gIH1cbiAgb3B0aW9ucyA9IGRlZmF1bHRPcHRpb25zO1xuXG4gIGNyZWF0ZUN0eCh0aWxlc01hdHJpeDogSVRpbGVbXVtdLCBjYW52YXM6IEhUTUxDYW52YXNFbGVtZW50KTogQ2FudmFzUmVuZGVyaW5nQ29udGV4dDJEIHtcbiAgICBjb25zdCBjdHggPSBjYW52YXMuZ2V0Q29udGV4dCgnMmQnKSE7XG4gICAgY29uc3QgcGl4ZWxHcmlkU2l6ZSA9IFxuICAgICAgdGhpcy5nZXRQaXhlbEdyaWRTaXplKHRpbGVzTWF0cml4LCB0aGlzLm9wdGlvbnMuZ3V0dGVyKTtcbiAgICBjYW52YXMud2lkdGggPSBwaXhlbEdyaWRTaXplLndpZHRoO1xuICAgIGNhbnZhcy5oZWlnaHQgPSBwaXhlbEdyaWRTaXplLmhlaWdodDtcbiAgICBjYW52YXMuc3R5bGUuY3Vyc29yID0gJ3BvaW50ZXInO1xuICAgIHJldHVybiBjdHg7XG4gIH1cblxuICBidWlsZFRpbGVzTWF0cml4KCk6IHsgcGl4ZWxHcmlkOiBQaXhlbEdyaWQsIHRpbGVzTWF0cml4OiBJVGlsZVtdW10gfSB7XG4gICAgY29uc3Qge1xuICAgICAgY29sdW1ucywgcm93cywgZ3V0dGVyLFxuICAgICAgdGlsZVNpemUsIHRpbGVDb2xvciwgdGlsZUhvdmVyQ29sb3JcbiAgfSA9IHRoaXMub3B0aW9uc1xuICAgIGNvbnN0IHBpeGVsR3JpZCA9IG5ldyBQaXhlbEdyaWQoY29sdW1ucywgcm93cywgZ3V0dGVyKTtcbiAgICBjb25zdCB0aWxlc01hdHJpeCA9IHBpeGVsR3JpZC5idWlsZFRpbGVzTWF0cml4KHRpbGVTaXplLCB0aWxlQ29sb3IsIHRpbGVIb3ZlckNvbG9yKTtcbiAgICByZXR1cm4geyBwaXhlbEdyaWQsIHRpbGVzTWF0cml4fTtcbiAgfVxuXG4gIGdldFBpeGVsR3JpZFNpemUodGlsZXNNYXRyaXg6IElUaWxlW11bXSwgZ3V0dGVyOiBudW1iZXIpOiBJU2l6ZSB7XG4gICAgY29uc3Qgd2lkdGggPSB0aWxlc01hdHJpeFswXS5sZW5ndGggKiB0aWxlc01hdHJpeFswXVswXS5zaXplLndpZHRoICsgKHRpbGVzTWF0cml4WzBdLmxlbmd0aCAtIDEpICogZ3V0dGVyO1xuICAgIGNvbnN0IGhlaWdodCA9IHRpbGVzTWF0cml4Lmxlbmd0aCAqIHRpbGVzTWF0cml4WzBdWzBdLnNpemUuaGVpZ2h0ICsgKHRpbGVzTWF0cml4Lmxlbmd0aCAtIDEpICogZ3V0dGVyO1xuICAgIHJldHVybiB7IHdpZHRoLCBoZWlnaHQgfTtcbiAgfVxuXG4gIG1lcmdlVGlsZXNNYXRyaXgodGlsZXNNYXRyaXg6IElUaWxlW11bXSwgdGlsZXM6IElUaWxlW10pOiBJVGlsZVtdW10ge1xuICAgIHRpbGVzLmZvckVhY2goKHRpbGU6IElUaWxlKSA9PiB7XG4gICAgICBjb25zdCB0aWxlQ29vcmRpbmF0ZXMgPSB0aWxlLmNvb3JkaW5hdGVzO1xuICAgICAgY29uc3QgeyB4LCB5IH0gPSB0aWxlQ29vcmRpbmF0ZXM7XG4gICAgICAvLyBtYWtlIGEgY29weSBvZiB0aWxlc01hdHJpeFt4XVt5XVxuICAgICAgY29uc3QgdGVzdCA9IGAke3RpbGVzTWF0cml4W3hdW3ldLmlkfWA7XG4gICAgICBjb25zb2xlLmxvZyh7XG4gICAgICAgIHRlc3QsXG4gICAgICAgIHNob3VsZEJlOiBgJHsoeCArIDEwKSAgKiAoeSArIDEwKX1gLFxuICAgICAgICB0aWxlXG4gICAgICB9KTtcbiAgICAgIFxuXG4gICAgICBjb25zdCBfdGlsZSA9IHRpbGVzTWF0cml4W3hdW3ldO1xuICAgICAgT2JqZWN0LmFzc2lnbihfdGlsZSwge1xuICAgICAgICBpc1BpeGVsOiB0cnVlLFxuICAgICAgICBpbWc6IHRpbGUuaW1nLFxuICAgICAgICBjb2xvcjogJ3JiZygwLCAwLCAwKScsXG4gICAgICAgIGhyZWY6IHRpbGUuaHJlZixcbiAgICAgICAgdG9vbHRpcFRleHQ6IHRpbGUudG9vbHRpcFRleHRcbiAgICAgIH0pO1xuICAgIH0pO1xuICAgIHJldHVybiB0aWxlc01hdHJpeDtcbiAgfVxuXG4gIHdoYXRUaWxlSXNNb3VzZU92ZXIodGlsZXNNYXRyaXg6IElUaWxlW11bXSwgcmVjdDogRE9NUmVjdCwgZXZlbnQ6IE1vdXNlRXZlbnQpOiBJVGlsZSB8IHVuZGVmaW5lZCB7XG4gICAgY29uc3QgeCA9IGV2ZW50LmNsaWVudFggLSByZWN0LmxlZnQ7XG4gICAgY29uc3QgeSA9IGV2ZW50LmNsaWVudFkgLSByZWN0LnRvcDtcblxuICAgIGxldCByZXR1cm5UaWxlOiBJVGlsZSB8IHVuZGVmaW5lZDtcbiAgICB0aWxlc01hdHJpeC5mb3JFYWNoKChyb3cpID0+IHtcbiAgICAgIHJvdy5mb3JFYWNoKCh0aWxlKSA9PiB7XG4gICAgICAgIGlmICh4ID49IHRpbGUuY29vcmRpbmF0ZXMueCAmJiB4IDw9IHRpbGUuY29vcmRpbmF0ZXMueCArIHRpbGUuc2l6ZS53aWR0aCAmJlxuICAgICAgICAgICAgeSA+PSB0aWxlLmNvb3JkaW5hdGVzLnkgJiYgeSA8PSB0aWxlLmNvb3JkaW5hdGVzLnkgKyB0aWxlLnNpemUuaGVpZ2h0KSB7XG4gICAgICAgICAgICByZXR1cm5UaWxlID0gdGlsZTtcbiAgICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9KTtcbiAgICByZXR1cm4gcmV0dXJuVGlsZTtcbiAgfVxuXG4gIHBoeWxsb3RheGlzTGF5b3V0KHRpbGVzTWF0cml4OiBJVGlsZVtdW10sIHhPZmZzZXQgPSAwLCB5T2Zmc2V0ID0gMCwgaU9mZnNldCA9IDApOiBJVGlsZVtdW10ge1xuICAgIC8vIHRoZXRhIGRldGVybWluZXMgdGhlIHNwaXJhbCBvZiB0aGUgbGF5b3V0XG4gICAgY29uc3QgdGhldGEgPSBNYXRoLlBJICogKDMgLSBNYXRoLnNxcnQoNSkpO1xuICAgIGNvbnN0IHBvaW50UmFkaXVzID0gdGhpcy5vcHRpb25zLnRpbGVTaXplLndpZHRoIC8gMjtcbiAgXG4gICAgdGlsZXNNYXRyaXguZm9yRWFjaCgocm93LCBpKSA9PiB7XG4gICAgICBjb25zdCBpbmRleCA9IChpICsgaU9mZnNldCkgJSB0aWxlc01hdHJpeC5sZW5ndGg7XG4gICAgICBjb25zdCBwaHlsbG9YID0gcG9pbnRSYWRpdXMgKiBNYXRoLnNxcnQoaW5kZXgpICogTWF0aC5jb3MoaW5kZXggKiB0aGV0YSk7XG4gICAgICBjb25zdCBwaHlsbG9ZID0gcG9pbnRSYWRpdXMgKiBNYXRoLnNxcnQoaW5kZXgpICogTWF0aC5zaW4oaW5kZXggKiB0aGV0YSk7XG4gICAgICByb3cuZm9yRWFjaCh0aWxlID0+IHtcbiAgICAgICAgdGlsZS5jb29yZGluYXRlcy54ID0geE9mZnNldCArIHBoeWxsb1ggLSBwb2ludFJhZGl1cztcbiAgICAgICAgdGlsZS5jb29yZGluYXRlcy55ID0geU9mZnNldCArIHBoeWxsb1kgLSBwb2ludFJhZGl1cztcbiAgICAgIH0pO1xuICAgIH0pO1xuICBcbiAgICByZXR1cm4gdGlsZXNNYXRyaXg7XG4gIH1cbn1cblxuXG5cbiJdfQ==