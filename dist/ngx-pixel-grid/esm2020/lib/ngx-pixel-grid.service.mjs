import { Inject, Injectable, InjectionToken, Optional } from '@angular/core';
import { PixelGrid } from './classes/pixel-grid';
import * as i0 from "@angular/core";
export const NGX_PIXEL_GRID_OPTIONS = new InjectionToken('NGX_PIXEL_GRID_OPTIONS');
const defaultOptions = {
    introAnimation: true,
    gutter: 1,
    rows: 100,
    columns: 100,
    tileSize: { width: 10, height: 10 },
    tileColor: 'rgb(140, 140, 140)',
    tileHoverColor: 'rgb(70, 70, 70)'
};
export class NgxPixelGridService {
    constructor(options) {
        this.options = defaultOptions;
        options && Object.assign(this.options, options);
    }
    createCtx(tilesMatrix, canvas) {
        const ctx = canvas.getContext('2d');
        ctx.imageSmoothingEnabled = false;
        const pixelGridSize = this.getPixelGridSize(tilesMatrix, this.options.gutter);
        canvas.width = pixelGridSize.width;
        canvas.height = pixelGridSize.height;
        canvas.style.cursor = 'pointer';
        return ctx;
    }
    buildTilesMatrix() {
        const { columns, rows, gutter, tileSize, tileColor, tileHoverColor } = this.options;
        const pixelGrid = new PixelGrid(columns, rows, gutter);
        const tilesMatrix = pixelGrid.buildTilesMatrix(tileSize, tileColor, tileHoverColor);
        return { pixelGrid, tilesMatrix };
    }
    getPixelGridSize(tilesMatrix, gutter) {
        const width = tilesMatrix[0].length * tilesMatrix[0][0].size.width + (tilesMatrix[0].length - 1) * gutter;
        const height = tilesMatrix.length * tilesMatrix[0][0].size.height + (tilesMatrix.length - 1) * gutter;
        return { width, height };
    }
    mergeTilesMatrix(tilesMatrix, tiles) {
        tiles.forEach((tile) => {
            const img = new Image();
            img.src = tile.base64;
            const tileCoordinates = tile.coordinates;
            const { x, y } = tileCoordinates;
            const _tile = tilesMatrix[x][y];
            Object.assign(_tile, {
                isPixel: true,
                img,
                color: 'rbg(0, 0, 0)',
                href: tile.href,
                tooltipText: tile.tooltipText
            });
        });
        return tilesMatrix;
    }
    whatTileIsMouseOver(tilesMatrix, rect, event) {
        const x = event.clientX - rect.left;
        const y = event.clientY - rect.top;
        let returnTile;
        tilesMatrix.forEach((row) => {
            row.forEach((tile) => {
                if (x >= tile.coordinates.x && x <= tile.coordinates.x + tile.size.width &&
                    y >= tile.coordinates.y && y <= tile.coordinates.y + tile.size.height) {
                    returnTile = tile;
                }
            });
        });
        return returnTile;
    }
    phyllotaxisLayout(tiles, xOffset = 0, yOffset = 0, iOffset = 0) {
        // const theta = Math.PI * (6 - Math.sqrt(20));
        // const pointRadius = 7;
        const theta = Math.PI * (3 - Math.sqrt(10));
        const pointRadius = 5;
        tiles.forEach((tile, i) => {
            const index = (i + iOffset) % tiles.length;
            const phylloX = pointRadius * Math.sqrt(index) * Math.cos(index * theta);
            const phylloY = pointRadius * Math.sqrt(index) * Math.sin(index * theta);
            tile.coordinates.x = xOffset + phylloX - pointRadius;
            tile.coordinates.y = yOffset + phylloY - pointRadius;
            tile.size.width = 3;
            tile.size.height = 3;
            // tile.color = `hsla(300, ${~~(40 * Math.random() + 60)}%, ${~~(60 * Math.random() + 20)}%, 1)`;
        });
        return tiles;
    }
    gridLayout(tiles) {
        for (let row = 0; row < this.options.rows; row++) {
            for (let column = 0; column < this.options.columns; column++) {
                const tile = tiles[row * this.options.columns + column];
                tile.coordinates.x = column * (this.options.tileSize.width + this.options.gutter);
                tile.coordinates.y = row * (this.options.tileSize.height + this.options.gutter);
                tile.size.width = 9;
                tile.size.height = 9;
                // tile.color = this.options.tileColor;
            }
        }
        return tiles;
    }
}
NgxPixelGridService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "14.2.12", ngImport: i0, type: NgxPixelGridService, deps: [{ token: NGX_PIXEL_GRID_OPTIONS, optional: true }], target: i0.ɵɵFactoryTarget.Injectable });
NgxPixelGridService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "14.2.12", ngImport: i0, type: NgxPixelGridService, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "14.2.12", ngImport: i0, type: NgxPixelGridService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root'
                }]
        }], ctorParameters: function () { return [{ type: undefined, decorators: [{
                    type: Optional
                }, {
                    type: Inject,
                    args: [NGX_PIXEL_GRID_OPTIONS]
                }] }]; } });
function getRandomArbitaryInt(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmd4LXBpeGVsLWdyaWQuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3Byb2plY3RzL25neC1waXhlbC1ncmlkL3NyYy9saWIvbmd4LXBpeGVsLWdyaWQuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxjQUFjLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzdFLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQzs7QUFHakQsTUFBTSxDQUFDLE1BQU0sc0JBQXNCLEdBQUcsSUFBSSxjQUFjLENBQW9CLHdCQUF3QixDQUFDLENBQUM7QUFDdEcsTUFBTSxjQUFjLEdBQXNCO0lBQ3hDLGNBQWMsRUFBRSxJQUFJO0lBQ3BCLE1BQU0sRUFBRSxDQUFDO0lBQ1QsSUFBSSxFQUFFLEdBQUc7SUFDVCxPQUFPLEVBQUUsR0FBRztJQUNaLFFBQVEsRUFBRSxFQUFFLEtBQUssRUFBRSxFQUFFLEVBQUUsTUFBTSxFQUFFLEVBQUUsRUFBRTtJQUNuQyxTQUFTLEVBQUUsb0JBQW9CO0lBQy9CLGNBQWMsRUFBRSxpQkFBaUI7Q0FDbEMsQ0FBQztBQUtGLE1BQU0sT0FBTyxtQkFBbUI7SUFFOUIsWUFBd0QsT0FBMEI7UUFHbEYsWUFBTyxHQUFHLGNBQWMsQ0FBQztRQUZ2QixPQUFPLElBQUksTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQ2xELENBQUM7SUFHRCxTQUFTLENBQUMsV0FBc0IsRUFBRSxNQUF5QjtRQUN6RCxNQUFNLEdBQUcsR0FBRyxNQUFNLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBRSxDQUFDO1FBQ3JDLEdBQUcsQ0FBQyxxQkFBcUIsR0FBRyxLQUFLLENBQUM7UUFDbEMsTUFBTSxhQUFhLEdBQ2pCLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxXQUFXLEVBQUUs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QztnQkFDckIsdUNBQXVDO2FBQ3hDO1NBQ0Y7UUFDRCxPQUFPLEtBQUssQ0FBQztJQUNmLENBQUM7O2lIQXJHVSxtQkFBbUIsa0JBRUUsc0JBQXNCO3FIQUYzQyxtQkFBbUIsY0FGbEIsTUFBTTs0RkFFUCxtQkFBbUI7a0JBSC9CLFVBQVU7bUJBQUM7b0JBQ1YsVUFBVSxFQUFFLE1BQU07aUJBQ25COzswQkFHYyxRQUFROzswQkFBSSxNQUFNOzJCQUFDLHNCQUFzQjs7QUF1R3hELFNBQVMsb0JBQW9CLENBQUMsR0FBVyxFQUFFLEdBQVc7SUFDcEQsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsR0FBRyxDQUFDLEdBQUcsR0FBRyxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxHQUFHLENBQUM7QUFDM0QsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdCwgSW5qZWN0YWJsZSwgSW5qZWN0aW9uVG9rZW4sIE9wdGlvbmFsIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBQaXhlbEdyaWQgfSBmcm9tICcuL2NsYXNzZXMvcGl4ZWwtZ3JpZCc7XG5pbXBvcnQgeyBJUGl4ZWxHcmlkT3B0aW9ucywgSVBpeGVsR3JpZFNlcnZpY2UsIElTaXplLCBJVGlsZSB9IGZyb20gJy4vaW50ZXJmYWNlcy9uZ3gtcGl4ZWwtZ3JpZCc7XG5cbmV4cG9ydCBjb25zdCBOR1hfUElYRUxfR1JJRF9PUFRJT05TID0gbmV3IEluamVjdGlvblRva2VuPElQaXhlbEdyaWRPcHRpb25zPignTkdYX1BJWEVMX0dSSURfT1BUSU9OUycpO1xuY29uc3QgZGVmYXVsdE9wdGlvbnM6IElQaXhlbEdyaWRPcHRpb25zID0ge1xuICBpbnRyb0FuaW1hdGlvbjogdHJ1ZSxcbiAgZ3V0dGVyOiAxLFxuICByb3dzOiAxMDAsXG4gIGNvbHVtbnM6IDEwMCxcbiAgdGlsZVNpemU6IHsgd2lkdGg6IDEwLCBoZWlnaHQ6IDEwIH0sXG4gIHRpbGVDb2xvcjogJ3JnYigxNDAsIDE0MCwgMTQwKScsXG4gIHRpbGVIb3ZlckNvbG9yOiAncmdiKDcwLCA3MCwgNzApJ1xufTtcblxuQEluamVjdGFibGUoe1xuICBwcm92aWRlZEluOiAncm9vdCdcbn0pXG5leHBvcnQgY2xhc3MgTmd4UGl4ZWxHcmlkU2VydmljZSBpbXBsZW1lbnRzIElQaXhlbEdyaWRTZXJ2aWNlIHtcblxuICBjb25zdHJ1Y3RvcihAT3B0aW9uYWwoKSBASW5qZWN0KE5HWF9QSVhFTF9HUklEX09QVElPTlMpIG9wdGlvbnM6IElQaXhlbEdyaWRPcHRpb25zKSB7IFxuICAgIG9wdGlvbnMgJiYgT2JqZWN0LmFzc2lnbih0aGlzLm9wdGlvbnMsIG9wdGlvbnMpO1xuICB9XG4gIG9wdGlvbnMgPSBkZWZhdWx0T3B0aW9ucztcblxuICBjcmVhdGVDdHgodGlsZXNNYXRyaXg6IElUaWxlW11bXSwgY2FudmFzOiBIVE1MQ2FudmFzRWxlbWVudCk6IENhbnZhc1JlbmRlcmluZ0NvbnRleHQyRCB7XG4gICAgY29uc3QgY3R4ID0gY2FudmFzLmdldENvbnRleHQoJzJkJykhO1xuICAgIGN0eC5pbWFnZVNtb290aGluZ0VuYWJsZWQgPSBmYWxzZTtcbiAgICBjb25zdCBwaXhlbEdyaWRTaXplID0gXG4gICAgICB0aGlzLmdldFBpeGVsR3JpZFNpemUodGlsZXNNYXRyaXgsIHRoaXMub3B0aW9ucy5ndXR0ZXIpO1xuICAgIGNhbnZhcy53aWR0aCA9IHBpeGVsR3JpZFNpemUud2lkdGg7XG4gICAgY2FudmFzLmhlaWdodCA9IHBpeGVsR3JpZFNpemUuaGVpZ2h0O1xuICAgIGNhbnZhcy5zdHlsZS5jdXJzb3IgPSAncG9pbnRlcic7XG4gICAgcmV0dXJuIGN0eDtcbiAgfVxuXG4gIGJ1aWxkVGlsZXNNYXRyaXgoKTogeyBwaXhlbEdyaWQ6IFBpeGVsR3JpZCwgdGlsZXNNYXRyaXg6IElUaWxlW11bXSB9IHtcbiAgICBjb25zdCB7XG4gICAgICBjb2x1bW5zLCByb3dzLCBndXR0ZXIsXG4gICAgICB0aWxlU2l6ZSwgdGlsZUNvbG9yLCB0aWxlSG92ZXJDb2xvclxuICB9ID0gdGhpcy5vcHRpb25zXG4gICAgY29uc3QgcGl4ZWxHcmlkID0gbmV3IFBpeGVsR3JpZChjb2x1bW5zLCByb3dzLCBndXR0ZXIpO1xuICAgIGNvbnN0IHRpbGVzTWF0cml4ID0gcGl4ZWxHcmlkLmJ1aWxkVGlsZXNNYXRyaXgodGlsZVNpemUsIHRpbGVDb2xvciwgdGlsZUhvdmVyQ29sb3IpO1xuICAgIHJldHVybiB7IHBpeGVsR3JpZCwgdGlsZXNNYXRyaXh9O1xuICB9XG5cbiAgZ2V0UGl4ZWxHcmlkU2l6ZSh0aWxlc01hdHJpeDogSVRpbGVbXVtdLCBndXR0ZXI6IG51bWJlcik6IElTaXplIHtcbiAgICBjb25zdCB3aWR0aCA9IHRpbGVzTWF0cml4WzBdLmxlbmd0aCAqIHRpbGVzTWF0cml4WzBdWzBdLnNpemUud2lkdGggKyAodGlsZXNNYXRyaXhbMF0ubGVuZ3RoIC0gMSkgKiBndXR0ZXI7XG4gICAgY29uc3QgaGVpZ2h0ID0gdGlsZXNNYXRyaXgubGVuZ3RoICogdGlsZXNNYXRyaXhbMF1bMF0uc2l6ZS5oZWlnaHQgKyAodGlsZXNNYXRyaXgubGVuZ3RoIC0gMSkgKiBndXR0ZXI7XG4gICAgcmV0dXJuIHsgd2lkdGgsIGhlaWdodCB9O1xuICB9XG5cbiAgbWVyZ2VUaWxlc01hdHJpeCh0aWxlc01hdHJpeDogSVRpbGVbXVtdLCB0aWxlczogSVRpbGVbXSk6IElUaWxlW11bXSB7XG4gICAgdGlsZXMuZm9yRWFjaCgodGlsZTogSVRpbGUpID0+IHtcbiAgICAgIGNvbnN0IGltZyA9IG5ldyBJbWFnZSgpO1xuICAgICAgaW1nLnNyYyA9IHRpbGUuYmFzZTY0ITtcblxuICAgICAgY29uc3QgdGlsZUNvb3JkaW5hdGVzID0gdGlsZS5jb29yZGluYXRlcztcbiAgICAgIGNvbnN0IHsgeCwgeSB9ID0gdGlsZUNvb3JkaW5hdGVzO1xuICAgICAgY29uc3QgX3RpbGUgPSB0aWxlc01hdHJpeFt4XVt5XTtcbiAgICAgIE9iamVjdC5hc3NpZ24oX3RpbGUsIHtcbiAgICAgICAgaXNQaXhlbDogdHJ1ZSxcbiAgICAgICAgaW1nLFxuICAgICAgICBjb2xvcjogJ3JiZygwLCAwLCAwKScsXG4gICAgICAgIGhyZWY6IHRpbGUuaHJlZixcbiAgICAgICAgdG9vbHRpcFRleHQ6IHRpbGUudG9vbHRpcFRleHRcbiAgICAgIH0pO1xuICAgIH0pO1xuICAgIHJldHVybiB0aWxlc01hdHJpeDtcbiAgfVxuXG4gIHdoYXRUaWxlSXNNb3VzZU92ZXIodGlsZXNNYXRyaXg6IElUaWxlW11bXSwgcmVjdDogRE9NUmVjdCwgZXZlbnQ6IE1vdXNlRXZlbnQpOiBJVGlsZSB8IHVuZGVmaW5lZCB7XG4gICAgY29uc3QgeCA9IGV2ZW50LmNsaWVudFggLSByZWN0LmxlZnQ7XG4gICAgY29uc3QgeSA9IGV2ZW50LmNsaWVudFkgLSByZWN0LnRvcDtcblxuICAgIGxldCByZXR1cm5UaWxlOiBJVGlsZSB8IHVuZGVmaW5lZDtcbiAgICB0aWxlc01hdHJpeC5mb3JFYWNoKChyb3cpID0+IHtcbiAgICAgIHJvdy5mb3JFYWNoKCh0aWxlKSA9PiB7XG4gICAgICAgIGlmICh4ID49IHRpbGUuY29vcmRpbmF0ZXMueCAmJiB4IDw9IHRpbGUuY29vcmRpbmF0ZXMueCArIHRpbGUuc2l6ZS53aWR0aCAmJlxuICAgICAgICAgICAgeSA+PSB0aWxlLmNvb3JkaW5hdGVzLnkgJiYgeSA8PSB0aWxlLmNvb3JkaW5hdGVzLnkgKyB0aWxlLnNpemUuaGVpZ2h0KSB7XG4gICAgICAgICAgICByZXR1cm5UaWxlID0gdGlsZTtcbiAgICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9KTtcbiAgICByZXR1cm4gcmV0dXJuVGlsZTtcbiAgfVxuXG4gIHBoeWxsb3RheGlzTGF5b3V0KHRpbGVzOiBJVGlsZVtdLCB4T2Zmc2V0ID0gMCwgeU9mZnNldCA9IDAsIGlPZmZzZXQgPSAwKTogSVRpbGVbXSB7XG4gICAgLy8gY29uc3QgdGhldGEgPSBNYXRoLlBJICogKDYgLSBNYXRoLnNxcnQoMjApKTtcbiAgICAvLyBjb25zdCBwb2ludFJhZGl1cyA9IDc7XG4gICAgY29uc3QgdGhldGEgPSBNYXRoLlBJICogKDMgLSBNYXRoLnNxcnQoMTApKTtcbiAgICBjb25zdCBwb2ludFJhZGl1cyA9IDU7XG4gIFxuICAgIHRpbGVzLmZvckVhY2goKHRpbGUsIGkpID0+IHtcbiAgICAgICAgY29uc3QgaW5kZXggPSAoaSArIGlPZmZzZXQpICUgdGlsZXMubGVuZ3RoO1xuICAgICAgICBjb25zdCBwaHlsbG9YID0gcG9pbnRSYWRpdXMgKiBNYXRoLnNxcnQoaW5kZXgpICogTWF0aC5jb3MoaW5kZXggKiB0aGV0YSk7XG4gICAgICAgIGNvbnN0IHBoeWxsb1kgPSBwb2ludFJhZGl1cyAqIE1hdGguc3FydChpbmRleCkgKiBNYXRoLnNpbihpbmRleCAqIHRoZXRhKTtcbiAgICAgICAgdGlsZS5jb29yZGluYXRlcy54ID0geE9mZnNldCArIHBoeWxsb1ggLSBwb2ludFJhZGl1cztcbiAgICAgICAgdGlsZS5jb29yZGluYXRlcy55ID0geU9mZnNldCArIHBoeWxsb1kgLSBwb2ludFJhZGl1cztcbiAgICAgICAgdGlsZS5zaXplLndpZHRoID0gMztcbiAgICAgICAgdGlsZS5zaXplLmhlaWdodCA9IDM7XG4gICAgICAgIC8vIHRpbGUuY29sb3IgPSBgaHNsYSgzMDAsICR7fn4oNDAgKiBNYXRoLnJhbmRvbSgpICsgNjApfSUsICR7fn4oNjAgKiBNYXRoLnJhbmRvbSgpICsgMjApfSUsIDEpYDtcbiAgICB9KTtcbiAgXG4gICAgcmV0dXJuIHRpbGVzO1xuICB9XG5cbiAgZ3JpZExheW91dCh0aWxlczogSVRpbGVbXSk6IElUaWxlW10ge1xuICAgIGZvciAobGV0IHJvdyA9IDA7IHJvdyA8IHRoaXMub3B0aW9ucy5yb3dzOyByb3crKykge1xuICAgICAgZm9yIChsZXQgY29sdW1uID0gMDsgY29sdW1uIDwgdGhpcy5vcHRpb25zLmNvbHVtbnM7IGNvbHVtbisrKSB7XG4gICAgICAgIGNvbnN0IHRpbGUgPSB0aWxlc1tyb3cgKiB0aGlzLm9wdGlvbnMuY29sdW1ucyArIGNvbHVtbl07XG4gICAgICAgIHRpbGUuY29vcmRpbmF0ZXMueCA9IGNvbHVtbiAqICh0aGlzLm9wdGlvbnMudGlsZVNpemUud2lkdGggKyB0aGlzLm9wdGlvbnMuZ3V0dGVyKTtcbiAgICAgICAgdGlsZS5jb29yZGluYXRlcy55ID0gcm93ICogKHRoaXMub3B0aW9ucy50aWxlU2l6ZS5oZWlnaHQgKyB0aGlzLm9wdGlvbnMuZ3V0dGVyKTtcbiAgICAgICAgdGlsZS5zaXplLndpZHRoID0gOTtcbiAgICAgICAgdGlsZS5zaXplLmhlaWdodCA9IDk7XG4gICAgICAgIC8vIHRpbGUuY29sb3IgPSB0aGlzLm9wdGlvbnMudGlsZUNvbG9yO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gdGlsZXM7XG4gIH1cbn1cblxuXG5mdW5jdGlvbiBnZXRSYW5kb21BcmJpdGFyeUludChtaW46IG51bWJlciwgbWF4OiBudW1iZXIpIHtcbiAgcmV0dXJuIE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIChtYXggLSBtaW4gKyAxKSkgKyBtaW47XG59Il19